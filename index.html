<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="utf-8">
<title>VloerenOffertePro</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--primary:#0d47a1;--secondary:#ff6f00;--ok:#2e7d32;--danger:#c62828;--bg:#f5f7fa;--card:#fff;--text:#212121;--mute:#757575;--radius:6px;}
*{box-sizing:border-box;font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;}
body{margin:0;background:var(--bg);color:var(--text);}
h1,h2,h3{margin:0 0 .5em;font-weight:600;}
.tabs{display:flex;border-bottom:2px solid var(--primary);}
.tabs button{flex:1;padding:12px;font-size:16px;border:none;background:#fff;cursor:pointer;transition:.2s;color:var(--primary);}
.tabs button.active{background:var(--primary);color:#fff;}
.tab-content{display:none;padding:20px;}
.tab-content.active{display:block;}
.row{display:flex;gap:20px;margin-bottom:20px;flex-wrap:wrap;}
.col{flex:1;min-width:280px;background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:0 1px 3px rgba(0,0,0,.08);}
label{display:block;margin:.5em 0 .2em;font-weight:600;font-size:14px;}
input,select,textarea{width:100%;padding:8px 10px;border:1px solid #bbb;border-radius:var(--radius);}
input[type=checkbox]{width:auto;margin-right:6px;}
.btn{padding:10px 18px;border:none;border-radius:var(--radius);cursor:pointer;font-size:15px;background:var(--primary);color:#fff;margin-top:10px;margin-right:8px;}
.btn.secondary{background:var(--secondary);}
.btn.danger{background:var(--danger);}
.btn.success{background:var(--ok);}
.kpi{background:var(--primary);color:#fff;padding:20px;border-radius:var(--radius);text-align:center;font-size:26px;font-weight:700;margin-bottom:20px;}
table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:8px 10px;text-align:left;border-bottom:1px solid #e0e0e0;}
th{background:#fafafa;}
.preview-img{max-width:100%;max-height:220px;border-radius:var(--radius);}
canvas{max-width:100%;}
@media screen {.print-header{display:none;}}
@media print{
  body{background:#fff;color:#000;margin:0;}
  .tabs,.btn{display:none !important;}
  .print-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;border-bottom:2px solid var(--primary);padding-bottom:10px;}
  .print-header img{height:60px;}
  .print-header .co-info{text-align:right;font-size:13px;line-height:1.4;}
  .row{page-break-inside:avoid;}
  table.details th.nr,table.details td.nr{text-align:right;}
  table.details tr.tot{background:#f5f5f5;font-weight:700;}
}
.material-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr 1fr auto;gap:8px;margin-bottom:8px;align-items:center;}
.material-row input,.material-row select{padding:6px;font-size:13px;}
</style>
</head>
<body>

<div class="tabs">
    <button class="active" onclick="switchTab(event,'calc')">Calculatie</button>
    <button onclick="switchTab(event,'quote')">Offerte</button>
    <button onclick="switchTab(event,'mgmt')">Management</button>
</div>

<!-- ========================== CALCULATIE ========================== -->
<div id="calc" class="tab-content active">
    <h1>1. Project &amp; Klantgegevens</h1>
    <div class="row"><div class="col">
        <label>Projectnaam *</label><input id="projName" placeholder="Woonkamer Familie De Vries">
        <label>Klantnaam</label><input id="custName" placeholder="Zoek of typ">
        <label>Projectadres *</label><input id="projAdres" placeholder="Straat 1, 1234 AB Stad">
        <label>Status</label>
        <select id="status"><option>Concept</option><option>Verzonden</option><option>Aangepast</option><option>Gewonnen</option><option>Verloren</option></select>
    </div></div>

    <h1>2. Vloerkeuze &amp; Hoeveelheden</h1>
    <div class="row"><div class="col">
        <label>Vloeroppervlakte (mÂ²) *</label><input id="vlOppervl" type="number" step="0.1" oninput="bereken()">
        <label>Vloertype *</label>
        <select id="vlType" oninput="bereken()">
            <option value="">Kiesâ€¦</option>
            <option>PVC</option><option>Laminaat</option><option>Hout</option><option>Gietvloer</option><option>Tegels</option><option>Vloerbedekking</option>
        </select>
        <label>Product (Merk / Kleur)</label><input id="vlProd" placeholder="Quick-Step Classic â€“ Eik Wit">
        <label>Afwerking</label>
        <select id="afwerk"><option>Mat</option><option>Zijdeglans</option><option>Structuur</option></select>
        <label>Zaagverlies (%)</label><input id="zaagV" type="number" step="0.1" value="5" oninput="bereken()">
        <label>Netto vloerprijs (â‚¬/mÂ² excl.)</label><input id="vlPrijs" type="number" step="0.01" oninput="bereken()">
        <label>Totaal mÂ² vloer (incl. zaagverlies)</label><input id="vlTotaal" readonly>
    </div></div>

    <h1>3. Ondervloer, Plinten &amp; Toebehoren</h1>
    <div class="row"><div class="col">
        <label><input id="ondVereist" type="checkbox" oninput="bereken()"> Ondervloer vereist?</label>
        <label>Ondervloer selectie</label>
        <select id="ondKeuze" oninput="bereken()">
            <option value="">Kiesâ€¦</option>
            <option>Beton</option><option>Hout</option><option>Polystyreen</option><option>Anders</option>
        </select>
        <label>Ondervloer prijs (â‚¬/mÂ²)</label><input id="ondPrijs" type="number" step="0.01" oninput="bereken()">
        <label>Plint omtrek (m)</label><input id="omtrek" type="number" step="0.1" oninput="bereken()">
        <label>Plint selectie</label>
        <select id="plintKeuze" oninput="bereken()">
            <option value="">Kiesâ€¦</option>
            <option>Eiken</option><option>Duifenkast</option><option>Geen</option>
        </select>
        <label>Plint prijs (â‚¬/m)</label><input id="plintPrijs" type="number" step="0.01" oninput="bereken()">
    </div></div>

    <h1>4. Overige materialen (meerdere regels)</h1>
    <div class="row"><div class="col">
        <div id="materialContainer"></div>
        <button type="button" class="btn secondary" onclick="addMaterialRow()">+ Regel toevoegen</button>
    </div></div>

    <h1>5. Arbeid &amp; Service</h1>
    <div class="row"><div class="col">
        <label>Leggen vloer (â‚¬/mÂ²)</label><input id="leggen" type="number" step="0.01" oninput="bereken()">
        <label>Leggen toeslag (â‚¬/mÂ² of %)</label><input id="legToeslag" type="number" step="0.01" placeholder="0" oninput="bereken()">
        <label>Egaliseren (â‚¬/mÂ²)</label><input id="egal" type="number" step="0.01" oninput="bereken()">
        <label>Oude vloer verwijderen (â‚¬/mÂ²)</label><input id="oudVloer" type="number" step="0.01" oninput="bereken()">
        <label>Voorrijkosten / transport â‚¬</label><input id="vrijKosten" type="number" step="0.01" oninput="bereken()">
        <label>Vrij tekst (condities)</label><textarea id="vrijTekst" rows="3" placeholder="Niet inbegrepen: verwijdering meubels..."></textarea>
    </div></div>

    <h1>6. Finale Prijscalculatie</h1>
    <div class="row"><div class="col">
        <table>
            <tr><th>Post</th><th>Bedrag (â‚¬ excl.)</th></tr>
            <tr><td>Subtotaal Materialen</td><td id="subMat">0.00</td></tr>
            <tr><td>Subtotaal Arbeid</td><td id="subArb">0.00</td></tr>
            <tr><td>Totaal Netto</td><td id="totNetto">0.00</td></tr>
            <tr><td>BTW 21%</td><td id="btw">0.00</td></tr>
            <tr><td><strong>Totaal Offerteprijs (Bruto)</strong></td><td id="totBruto"><strong>0.00</strong></td></tr>
        </table>
        <button class="btn success" onclick="saveCalc()">Opslaan &amp; Offerte Tonen</button>
        <button type="button" class="btn danger" onclick="resetForm()">ðŸ—‘ Nieuw formulier</button>
        <button type="button" class="btn secondary" onclick="exportCSV()">Export CSV</button>
    </div></div>
</div>

<!-- ========================== OFFERTES ========================== -->
<div id="quote" class="tab-content"><div id="quotePreview"></div></div>

<!-- ========================== MANAGEMENT ======================= -->
<div id="mgmt" class="tab-content">
    <h1>Management Dashboard</h1>
    <div class="row">
        <div class="col"><div class="kpi" id="kpiAOV">Gem. Orderwaarde<br/>â‚¬ <span>0</span></div></div>
        <div class="col"><div class="kpi" id="kpiConv">Conversie<br/><span>0</span>â€¯%</div></div>
        <div class="col"><div class="kpi" id="kpiPipe">Pipeline<br/>â‚¬ <span>0</span></div></div>
    </div>
    <h2>Offerteâ€‘Pijplijn</h2><canvas id="pipeChart" height="120"></canvas>
    <h2>Redenen Verloren</h2><canvas id="lossChart" height="120"></canvas>
    <h2>Performance per Productgroep</h2><canvas id="prodChart" height="120"></canvas>
    <button class="btn" onclick="resetData()">Reset demo data</button>
</div>

<script>
/* ---------- GLOBAL STORE ---------- */
const STORE = {
    getCalc()   { return JSON.parse(localStorage.getItem('calc') || '{}'); },
    setCalc(o)  { localStorage.setItem('calc', JSON.stringify(o)); },
    getOffertes(){ return JSON.parse(localStorage.getItem('offertes') || '[]'); },
    setOffertes(arr){ localStorage.setItem('offertes', JSON.stringify(arr)); },
    addOfferte(o){
        const arr = this.getOffertes();
        o.id = Date.now();
        arr.push(o);
        this.setOffertes(arr);
    }
};

/* ---------- TABS ---------- */
function switchTab(ev, id){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tabs button').forEach(b=>b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    if (ev && ev.target) ev.target.classList.add('active');
    if (id === 'quote') renderQuote();
    if (id === 'mgmt') renderMgmt();
}

/* ---------- CALCULATE ---------- */
function bereken(){
    const vl   = parseFloat(document.getElementById('vlOppervl').value) || 0;
    const zv   = parseFloat(document.getElementById('zaagV').value) || 0;
    const vlTotaal = vl * (1 + zv/100);
    document.getElementById('vlTotaal').value = vlTotaal.toFixed(2);

    const vlPrijs   = parseFloat(document.getElementById('vlPrijs').value) || 0;
    const ondPrijs  = (document.getElementById('ondVereist').checked) ?
                     (parseFloat(document.getElementById('ondPrijs').value) || 0) : 0;
    const omtrek    = parseFloat(document.getElementById('omtrek').value) || 0;
    const plintPrijs = parseFloat(document.getElementById('plintPrijs').value) || 0;

    const materialTotal = getMaterialTotal();

    const subMat = (vlTotaal * vlPrijs) + (vl * ondPrijs) + (omtrek * plintPrijs) + materialTotal;

    const leggen   = parseFloat(document.getElementById('leggen').value) || 0;
    const toeslag  = parseFloat(document.getElementById('legToeslag').value) || 0;
    const egal     = parseFloat(document.getElementById('egal').value) || 0;
    const oud      = parseFloat(document.getElementById('oudVloer').value) || 0;
    const vrij     = parseFloat(document.getElementById('vrijKosten').value) || 0;

    const subArb = (vl * leggen) + (vl * toeslag) + (vl * egal) + (vl * oud) + vrij;

    const netto = subMat + subArb;
    const btw   = netto * 0.21;
    const bruto = netto + btw;

    document.getElementById('subMat').innerText   = subMat.toFixed(2);
    document.getElementById('subArb').innerText   = subArb.toFixed(2);
    document.getElementById('totNetto').innerText = netto.toFixed(2);
    document.getElementById('btw').innerText      = btw.toFixed(2);
    document.getElementById('totBruto').innerText = bruto.toFixed(2);
}

/* ---------- MATERIAL LOGIC ---------- */
const materialOptions = ['Lijm','Egalisatie','Primer','Voegkitt','Schuurpapier','Anders'];

function addMaterialRow(data = {}){
    const container = document.getElementById('materialContainer');
    const row = document.createElement('div');
    row.className = 'material-row';
    row.innerHTML = `
        <select class="matType">
            <option value="">Kiesâ€¦</option>
            ${materialOptions.map(o => `<option value="${o}" ${data.type===o?'selected':''}>${o}</option>`).join('')}
        </select>
        <input type="text"   class="matLeverancier" placeholder="Leverancier" value="${data.leverancier||''}">
        <input type="number" class="matAantal" placeholder="Aantal" step="0.01" value="${data.aantal||''}">
        <input type="text"   class="matEenheid" placeholder="Eenheid" value="${data.eenheid||''}">
        <input type="text"   class="matArtNr" placeholder="Art.nr." value="${data.artNr||''}">
        <input type="number" class="matPrijs" placeholder="Prijs/st" step="0.01" value="${data.prijs||''}">
        <button type="button" class="btn danger" onclick="removeMaterialRow(this)">Ã—</button>
    `;
    container.appendChild(row);
    row.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', bereken));
}
function removeMaterialRow(btn){
    btn.parentElement.remove();
    bereken();
}
function getMaterialTotal(){
    let tot = 0;
    document.querySelectorAll('.material-row').forEach(row=>{
        const aantal = parseFloat(row.querySelector('.matAantal').value) || 0;
        const prijs  = parseFloat(row.querySelector('.matPrijs').value)  || 0;
        tot += aantal * prijs;
    });
    return tot;
}
function getMaterialRowsArray(){
    const rows = [];
    document.querySelectorAll('.material-row').forEach(row=>{
        rows.push({
            type:        row.querySelector('.matType').value,
            leverancier: row.querySelector('.matLeverancier').value,
            aantal:      row.querySelector('.matAantal').value,
            eenheid:     row.querySelector('.matEenheid').value,
            artNr:       row.querySelector('.matArtNr').value,
            prijs:       row.querySelector('.matPrijs').value
        });
    });
    return rows;
}

/* ---------- SAVE / EXPORT / RESET ---------- */
function saveCalc(){
    const c = {
        projName:    document.getElementById('projName').value,
        custName:    document.getElementById('custName').value,
        projAdres:   document.getElementById('projAdres').value,
        status:      document.getElementById('status').value,
        vlOppervl:   document.getElementById('vlOppervl').value,
        vlType:      document.getElementById('vlType').value,
        vlProd:      document.getElementById('vlProd').value,
        vlPrijs:     document.getElementById('vlPrijs').value,
        zaagV:       document.getElementById('zaagV').value,
        vlTotaal:    document.getElementById('vlTotaal').value,
        ondVereist:  document.getElementById('ondVereist').checked,
        ondKeuze:    document.getElementById('ondKeuze').value,
        ondPrijs:    document.getElementById('ondPrijs').value,
        omtrek:      document.getElementById('omtrek').value,
        plintKeuze:  document.getElementById('plintKeuze').value,
        plintPrijs:  document.getElementById('plintPrijs').value,
        materialRows:getMaterialRowsArray(),
        leggen:      document.getElementById('leggen').value,
        legToeslag:  document.getElementById('legToeslag').value,
        egal:        document.getElementById('egal').value,
        oudVloer:    document.getElementById('oudVloer').value,
        vrijKosten:  document.getElementById('vrijKosten').value,
        vrijTekst:   document.getElementById('vrijTekst').value,
        subMat:      document.getElementById('subMat').innerText,
        subArb:      document.getElementById('subArb').innerText,
        totNetto:    document.getElementById('totNetto').innerText,
        btw:         document.getElementById('btw').innerText,
        totBruto:    document.getElementById('totBruto').innerText,
        date:        new Date().toISOString()
    };
    STORE.setCalc(c);
    STORE.addOfferte(c);
    switchTab({target:{}},'quote');
}
function exportCSV(){
    const c = STORE.getCalc();
    if (!c.projName) { alert('Niets om te exporteren â€“ sla eerst op.'); return; }
    let csv = 'Veld,Waarde\n';
    for (const k in c) { csv += `"${k}","${c[k]}"\n`; }
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `calculatie_${c.projName.replace(/\s+/g,'_')}.csv`;
    a.click();
}
function resetForm(){
    document.querySelectorAll('#calc input, #calc select, #calc textarea')
        .forEach(el=>{ if (el.type==='checkbox') el.checked = false; else el.value = ''; });
    document.getElementById('materialContainer').innerHTML = '';
    addMaterialRow();
    localStorage.removeItem('calc');
    bereken();
    switchTab({target:{}},'calc');
}

/* ---------- QUOTE ---------- */
function renderQuote(){
    const c = STORE.getCalc();
    if (!c.projName){
        document.getElementById('quotePreview').innerHTML = '<p>Geen offerte beschikbaar.</p>';
        return;
    }
    const logoB64 = '';   // â† optional baseâ€‘64 logo
    const vloerOms = (c.vlType === 'Vloerbedekking') ? 'Vloerbedekking' : `${c.vlType} vloer`;

    let materialRowsHtml = '';
    if (c.materialRows && c.materialRows.length){
        c.materialRows.forEach(r=>{
            const qty = parseFloat(r.aantal) || 0;
            const price = parseFloat(r.prijs) || 0;
            const tot = qty * price;
            materialRowsHtml += `
                <tr>
                    <td>${r.type} (${r.leverancier} - ${r.artNr})</td>
                    <td class="nr">${r.aantal} ${r.eenheid}</td>
                    <td class="nr">â‚¬ ${price.toFixed(2)}</td>
                    <td class="nr">â‚¬ ${tot.toFixed(2)}</td>
                </tr>`;
        });
    }

    const html = `
        <div class="print-header">
            <img src="data:image/png;base64,${logoB64}" alt="Logo">
            <div class="co-info">
                <strong>Next Generation Flooring</strong><br>
                Josephine Bakerstraat 18<br>
                1311 GA Almere<br>
                Tel: +31 020 210 1184<br>
                Eâ€‘mail: info@nextgenerationflooring.nl
            </div>
        </div>
        <div class="row">
            <div class="col">
                <h2>Offerte ${c.projName}</h2>
                <table class="meta">
                    <tr><td>Offertenummer:</td><td>NG-${c.id}</td></tr>
                    <tr><td>Datum:</td><td>${new Date(c.date).toLocaleDateString('nl-NL')}</td></tr>
                    <tr><td>Klant:</td><td>${c.custName||''}</td></tr>
                    <tr><td>Projectadres:</td><td>${c.projAdres||''}</td></tr>
                    <tr><td>Geldigheid:</td><td>30 dagen</td></tr>
                </table>
            </div>
            <div class="col">
                <img class="preview-img" src="https://source.unsplash.com/900x600/?floor,${c.vlType}"
                     alt="${c.vlProd||'Gekozen vloer'}">
            </div>
        </div>
        <div class="row">
            <div class="col">
                <h3>Prijsopbouw (â‚¬ incl. 21â€¯% BTW)</h3>
                <table class="details">
                    <thead><tr><th>Omschrijving</th><th class="nr">aantal</th><th class="nr">â‚¬ / eenh.</th><th class="nr">bedrag</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>${vloerOms}</td>
                            <td class="nr">${c.vlTotaal}â€¯mÂ²</td>
                            <td class="nr">â‚¬ ${parseFloat(c.vlPrijs).toFixed(2)}</td>
                            <td class="nr">â‚¬ ${(parseFloat(c.vlTotaal)*parseFloat(c.vlPrijs)).toFixed(2)}</td>
                        </tr>
                        ${c.ondVereist ? `
                        <tr>
                            <td>Ondervloer ${c.ondKeuze}</td>
                            <td class="nr">${c.vlOppervl}â€¯mÂ²</td>
                            <td class="nr">â‚¬ ${parseFloat(c.ondPrijs).toFixed(2)}</td>
                            <td class="nr">â‚¬ ${(parseFloat(c.vlOppervl)*parseFloat(c.ondPrijs)).toFixed(2)}</td>
                        </tr>` : ''}
                        <tr>
                            <td>Plinten ${c.plintKeuze}</td>
                            <td class="nr">${c.omtrek}â€¯m</td>
                            <td class="nr">â‚¬ ${parseFloat(c.plintPrijs).toFixed(2)}</td>
                            <td class="nr">â‚¬ ${(parseFloat(c.omtrek)*parseFloat(c.plintPrijs)).toFixed(2)}</td>
                        </tr>
                        ${materialRowsHtml}
                        <tr>
                            <td>Arbeid &amp; service</td>
                            <td class="nr"></td>
                            <td class="nr"></td>
                            <td class="nr">â‚¬ ${parseFloat(c.subArb).toFixed(2)}</td>
                        </tr>
                        <tr class="tot">
                            <td><strong>Totaal incl. 21â€¯% BTW</strong></td>
                            <td class="nr"></td>
                            <td class="nr"></td>
                            <td class="nr"><strong>â‚¬ ${parseFloat(c.totBruto).toFixed(2)}</strong></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <h3>Levering &amp; garantie</h3>
                <ul>
                    <li>Levertijd: 5â€‘10 werkdagen na akkoord</li>
                    <li>10â€¯jaar woonâ€‘garantie op de vloer</li>
                    <li>2â€¯jaar garantie op gehele installatie</li>
                    <li>Professionele legservice inbegrepen</li>
                </ul>
                <p><strong>Opmerkingen:</strong> ${c.vrijTekst||'Geen bijzonderheden.'}</p>
            </div>
        </div>
        <div class="row"><div class="col">
            <button class="btn success" onclick="alert('Bedankt â€“ u ontvangt binnen 1â€¯uur een bevestiging per eâ€‘mail!')">Offerte digitaal ondertekenen</button>
            <button class="btn secondary" onclick="window.print()">Download / print PDF</button>
        </div></div>`;
    document.getElementById('quotePreview').innerHTML = html;
}

/* ---------- MANAGEMENT ---------- */
function renderMgmt(){
    const list = STORE.getOffertes();

    const won = list.filter(o => o.status === 'Gewonnen');
    const verzonden = list.filter(o => ['Verzonden','Aangepast','Gewonnen','Verloren'].includes(o.status));

    const aov = won.length ? won.reduce((s,o)=>s+parseFloat(o.totBruto),0) / won.length : 0;
    const conv = verzonden.length ? (won.length / verzonden.length) * 100 : 0;
    const pipeline = list.filter(o=>['Concept','Verzonden','Aangepast'].includes(o.status))
                         .reduce((s,o)=>s+parseFloat(o.totBruto),0);

    document.querySelector('#kpiAOV span').innerText = aov.toFixed(0);
    document.querySelector('#kpiConv span').innerText = conv.toFixed(1);
    document.querySelector('#kpiPipe span').innerText = pipeline.toFixed(0);

    // pipeline bar chart â€“ counts per status
    drawBar('pipeChart',{
        labels:['Concept','Verzonden','Aangepast','Gewonnen','Verloren'],
        data:[
            list.filter(o=>o.status==='Concept').length,
            list.filter(o=>o.status==='Verzonden').length,
            list.filter(o=>o.status==='Aangepast').length,
            won.length,
            list.filter(o=>o.status==='Verloren').length
        ]
    });

    // static lossâ€‘reason pie chart
    drawPie('lossChart',['Prijs te hoog','Levertijd','Product niet beschikbaar','Andere'],
            [40,25,20,15]);

    // omzet per vloerâ€‘type (only won)
    const omzet = {};
    list.forEach(o=>{
        if (o.status==='Gewonnen'){
            const t = o.vlType||'Onbekend';
            omzet[t] = (omzet[t]||0) + parseFloat(o.totBruto);
        }
    });
    drawBar('prodChart',{labels:Object.keys(omzet),data:Object.values(omzet)});
}

/* ---------- CHART HELPERS ---------- */
function drawBar(canvasId,{labels,data}){
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const pad = 30;
    const w = canvas.width = canvas.offsetWidth;
    const h = canvas.height = 160;
    const slot = (w-2*pad)/labels.length;
    const barW = slot*0.7;
    const gap  = slot*0.3;
    const maxV = Math.max(...data,1);
    ctx.clearRect(0,0,w,h);
    labels.forEach((lbl,i)=>{
        const val = data[i];
        const bh = (val/maxV)*(h-2*pad);
        const x = pad + i*slot + gap/2;
        const y = h - pad - bh;
        ctx.fillStyle = '#0d47a1';
        ctx.fillRect(x,y,barW,bh);
        ctx.fillStyle = '#000';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText(val, x+barW/2, y-4);
        ctx.fillText(lbl, x+barW/2, h-pad+14);
    });
}
function drawPie(canvasId,labels,data){
    const canvas = document.getElementById(canvasId);
    const ctx = canvas.getContext('2d');
    const w = canvas.width = canvas.offsetWidth;
    const h = canvas.height = 160;
    const R = Math.min(w,h)/2 - 20;
    const total = data.reduce((a,b)=>a+b,0);
    const colors = ['#c62828','#ff6f00','#2e7d32','#0277bd','#9c27b0','#ff9800'];
    ctx.clearRect(0,0,w,h);
    let start = 0;
    data.forEach((val,i)=>{
        const angle = (val/total)*2*Math.PI;
        ctx.beginPath();
        ctx.moveTo(w/2,h/2);
        ctx.arc(w/2,h/2,R,start,start+angle);
        ctx.closePath();
        ctx.fillStyle = colors[i%colors.length];
        ctx.fill();
        start += angle;
    });
    // simple legend (optional)
    const legX = w - 110;
    let legY = 20;
    ctx.font = '12px sans-serif';
    labels.forEach((lab,i)=>{
        ctx.fillStyle = colors[i%colors.length];
        ctx.fillRect(legX,legY-12,12,12);
        ctx.fillStyle = '#000';
        ctx.fillText(`${lab} (${data[i]})`,legX+18,legY);
        legY += 20;
    });
}

/* ---------- DEMO DATA (reset) ---------- */
function resetData(){
    localStorage.removeItem('calc');
    localStorage.removeItem('offertes');

    const demo = [
        {
            projName:'Demo Projectâ€¯1',
            custName:'Demo Klant',
            projAdres:'Straatâ€¯1, 1234â€¯AB Demo',
            status:'Gewonnen',
            vlOppervl:'30',
            vlType:'PVC',
            vlProd:'Demo Vloer',
            vlPrijs:'25',
            zaagV:'5',
            vlTotaal:(30*1.05).toFixed(2),
            ondVereist:true,
            ondKeuze:'Beton',
            ondPrijs:'5',
            omtrek:'12',
            plintKeuze:'Eiken',
            plintPrijs:'3',
            materialRows:[],
            leggen:'15',
            legToeslag:'0',
            egal:'5',
            oudVloer:'0',
            vrijKosten:'50',
            vrijTekst:'',
            date:new Date().toISOString()
        },
        {
            projName:'Demo Projectâ€¯2',
            custName:'Klantâ€¯B',
            projAdres:'Straatâ€¯2, 5678â€¯CD Demo',
            status:'Concept',
            vlOppervl:'45',
            vlType:'Laminaat',
            vlProd:'Voorbeeld Laminaat',
            vlPrijs:'20',
            zaagV:'5',
            vlTotaal:(45*1.05).toFixed(2),
            ondVereist:false,
            ondKeuze:'',
            ondPrijs:'',
            omtrek:'15',
            plintKeuze:'Geen',
            plintPrijs:'0',
            materialRows:[],
            leggen:'12',
            legToeslag:'0',
            egal:'4',
            oudVloer:'2',
            vrijKosten:'30',
            vrijTekst:'',
            date:new Date().toISOString()
        }
    ];

    // compute totals for the demo rows
    demo.forEach(o=>{
        const vl = parseFloat(o.vlOppervl);
        const zv = parseFloat(o.zaagV);
        const vt = vl * (1 + zv/100);
        const subMat = (vt * parseFloat(o.vlPrijs)) +
                      (vl * (o.ondVereist ? parseFloat(o.ondPrijs) : 0)) +
                      (parseFloat(o.omtrek) * parseFloat(o.plintPrijs));
        const subArb = (vl * parseFloat(o.leggen)) +
                      (vl * parseFloat(o.legToeslag)) +
                      (vl * parseFloat(o.egal)) +
                      (vl * parseFloat(o.oudVloer)) +
                      parseFloat(o.vrijKosten);
        const netto = subMat + subArb;
        const btw   = netto * 0.21;
        const bruto = netto + btw;
        o.subMat   = subMat.toFixed(2);
        o.subArb   = subArb.toFixed(2);
        o.totNetto = netto.toFixed(2);
        o.btw      = btw.toFixed(2);
        o.totBruto = bruto.toFixed(2);
    });

    STORE.setOffertes(demo);
    switchTab({target:{}},'mgmt');
}

/* ---------- START ---------- */
(function(){
    addMaterialRow();                     // start with a single empty material line
    const saved = STORE.getCalc();
    if (saved.projName){
        if (saved.materialRows && saved.materialRows.length){
            document.getElementById('materialContainer').innerHTML = '';
            saved.materialRows.forEach(r=>addMaterialRow(r));
        }
        Object.keys(saved).forEach(k=>{
            const el = document.getElementById(k);
            if (el){
                if (el.type === 'checkbox') el.checked = saved[k];
                else el.value = saved[k];
            }
        });
        bereken();
    }
    if (!STORE.getOffertes().length) resetData();
})();
</script>
</body>
</html>